import sys
import numpy as np
import matplotlib.pyplot as plt
from PyQt5.QtWidgets import QApplication, QWidget, QVBoxLayout, QFormLayout, QLabel, QLineEdit, QPushButton, QHBoxLayout, QFrame
from PyQt5.QtCore import Qt
from PyQt5.QtGui import QPalette, QColor
from scipy.stats import binom

class App(QWidget):
    def __init__(self):
        super().__init__()

        self.setWindowTitle('Simulador de Overbooking e ROI')
        self.setGeometry(100, 100, 600, 500)

        # Estilização da interface
        self.setStyleSheet("""
            QWidget {
                background-color: #f5d0cb; /* Rosa claro */
                color: #4b0082; /* Texto roxo escuro */
                font-family: 'Arial', sans-serif;
            }
            QLabel {
                font-size: 14px;
                font-weight: bold;
            }
            QLineEdit {
                background-color: #ffffff;
                border: 2px solid #e5a1b7;
                border-radius: 5px;
                padding: 5px;
                font-size: 12px;
            }
            QPushButton {
                background-color: #f48fb1;
                color: white;
                border: 2px solid #f06292;
                border-radius: 5px;
                padding: 10px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #f06292;
            }
            QPushButton:pressed {
                background-color: #e91e63;
            }
            QFrame {
                border: 1px solid #e5a1b7;
                margin: 20px 0;
            }
        """)

        self.layout = QVBoxLayout()

        # Criando o layout do ROI
        self.roi_section = QVBoxLayout()
        self.roi_form = QFormLayout()
        self.ii_input = QLineEdit(self)
        self.coa_input = QLineEdit(self)
        self.re_input = QLineEdit(self)
        self.dpr_input = QLineEdit(self)
        self.n_simulacoes_input = QLineEdit(self)

        self.roi_form.addRow('Investimento Inicial (R$):', self.ii_input)
        self.roi_form.addRow('Custo Operacional Anual (R$):', self.coa_input)
        self.roi_form.addRow('Receita Esperada (R$):', self.re_input)
        self.roi_form.addRow('Desvio Padrão da Receita (R$):', self.dpr_input)
        self.roi_form.addRow('Número de Simulações:', self.n_simulacoes_input)

        # Criando o botão para calcular o ROI
        self.roi_button = QPushButton('Calcular ROI', self)
        self.roi_button.clicked.connect(self.calcular_roi)

        self.roi_section.addLayout(self.roi_form)
        self.roi_section.addWidget(self.roi_button)

        # Criando uma linha divisória entre ROI e Overbooking
        self.separator = QFrame(self)
        self.separator.setFrameShape(QFrame.HLine)
        self.separator.setFrameShadow(QFrame.Sunken)

        # Criando o layout do Overbooking
        self.overbooking_section = QVBoxLayout()
        self.overbooking_form = QFormLayout()
        self.n_input = QLineEdit(self)
        self.p_input = QLineEdit(self)
        self.k_input = QLineEdit(self)

        self.overbooking_form.addRow('Número de Passagens Vendidas:', self.n_input)
        self.overbooking_form.addRow('Probabilidade de Comparecimento:', self.p_input)
        self.overbooking_form.addRow('Capacidade da Aeronave:', self.k_input)

        # Criando o botão para calcular o Overbooking
        self.overbooking_button = QPushButton('Calcular Overbooking', self)
        self.overbooking_button.clicked.connect(self.calcular_overbooking)

        self.overbooking_section.addLayout(self.overbooking_form)
        self.overbooking_section.addWidget(self.overbooking_button)

        # Layout para os botões de cálculo
        self.buttons_layout = QHBoxLayout()
        self.buttons_layout.addWidget(self.roi_button)
        self.buttons_layout.addWidget(self.overbooking_button)

        # Resultado do ROI e Overbooking
        self.result_label = QLabel('Resultados serão exibidos aqui', self)

        # Adicionando os layouts ao widget principal
        self.layout.addLayout(self.roi_section)
        self.layout.addWidget(self.separator)
        self.layout.addLayout(self.overbooking_section)
        self.layout.addWidget(self.result_label)

        self.setLayout(self.layout)

    def calcular_roi(self):
        try:
            # Pegar os valores inseridos pelo usuário
            ii = float(self.ii_input.text())
            coa = float(self.coa_input.text())
            re = float(self.re_input.text())
            dpr = float(self.dpr_input.text())
            n_simulacoes = int(self.n_simulacoes_input.text())
        except ValueError as e:
            self.result_label.setText(f"Erro: Por favor, insira valores válidos. Detalhes: {str(e)}")
            return

        # Semente para simulações reprodutíveis
        np.random.seed(42)

        # Simulação de receitas
        receitas_simuladas = np.random.normal(loc=re, scale=dpr, size=n_simulacoes)

        # Cálculo do Lucro e ROI
        lucros = receitas_simuladas - coa
        rois = (lucros / ii) * 100

        # Cálculo da probabilidade de receita abaixo de R$ 60.000
        prob_receita_abaixo_60000 = np.mean(receitas_simuladas < 60000) * 100

        # Exibindo resultados no layout
        result_text = f"Probabilidade de Receita < R$60.000: {prob_receita_abaixo_60000:.2f}%"
        self.result_label.setText(result_text)

        # Gerar gráfico da distribuição das receitas simuladas
        self.plot_receitas(receitas_simuladas)

        # Gerar gráfico do ROI
        self.plot_roi(rois)

    def plot_receitas(self, receitas_simuladas):
        try:
            plt.figure(figsize=(10,6))
            plt.hist(receitas_simuladas, bins=50, color='lightblue', edgecolor='black')
            plt.title('Distribuição das Receitas Simuladas')
            plt.xlabel('Receita (R$)')
            plt.ylabel('Frequência')
            plt.grid(True)
            plt.show()
        except Exception as e:
            print(f"Erro ao plotar gráfico de receitas: {str(e)}")

    def plot_roi(self, rois):
        try:
            plt.figure(figsize=(10,6))
            plt.hist(rois, bins=50, color='lightgreen', edgecolor='black')
            plt.title('Distribuição dos ROIs Simulados')
            plt.xlabel('ROI (%)')
            plt.ylabel('Frequência')
            plt.grid(True)
            plt.show()
        except Exception as e:
            print(f"Erro ao plotar gráfico de ROI: {str(e)}")

    def calcular_overbooking(self):
        try:
            # Pegar os valores inseridos pelo usuário
            n = int(self.n_input.text())
            p = float(self.p_input.text())
            k = int(self.k_input.text())
        except ValueError as e:
            self.result_label.setText(f"Erro: Por favor, insira valores válidos. Detalhes: {str(e)}")
            return

        # Calcular a probabilidade de overbooking
        probabilidade_overbooking = 1 - binom.cdf(k, n, p)

        # Converter a probabilidade para porcentagem
        probabilidade_overbooking_percentual = probabilidade_overbooking * 100

        # Exibindo o resultado no layout
        result_text = f"A probabilidade de mais de {k} passageiros comparecerem é: {probabilidade_overbooking_percentual:.2f}%"
        self.result_label.setText(result_text)

        # Gerar gráfico do Overbooking
        self.plot_overbooking(n, p, k)

    def plot_overbooking(self, n, p, k):
        try:
            x = np.arange(0, n+1)
            y = binom.pmf(x, n, p)
            plt.figure(figsize=(10,6))
            plt.bar(x, y, color='skyblue', edgecolor='black')
            plt.title('Distribuição de Probabilidade de Overbooking')
            plt.xlabel('Número de Passageiros')
            plt.ylabel('Probabilidade')
            plt.axvline(x=k, color='red', linestyle='--', label=f'Capacidade da Aeronave ({k})')
            plt.legend()
            plt.grid(True)
            plt.show()
        except Exception as e:
            print(f"Erro ao plotar gráfico de Overbooking: {str(e)}")


if __name__ == '__main__':
    try:
        app = QApplication(sys.argv)
        window = App()
        window.show()
        sys.exit(app.exec_())
    except Exception as e:
        print(f"Erro ao iniciar o aplicativo: {str(e)}")
